<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.3//EN"
    "http://www.oasis-open.org/docbook/xml/4.3/docbookx.dtd"
[
<!ENTITY % sharedents SYSTEM "shared-entities.xml" >
%sharedents;
]>
<chapter id="imagetransfer-software" xmlns:xi="http://www.w3.org/2001/XInclude">
  <info>
    <author>
      <firstname>Owen</firstname>
      <surname>Synge</surname>
    </author>
  </info>
  <title>Virtual Image Transfer Software</title>
  <para>This chapter describes the software components that have
  been and need to be developed to complete cross site image
  transfer.</para>
  <para>The software and implementation is only one of many possible solutions that could be 
    produced to solve the objectives of the &vwg;.</para>
  <section id="imagetransfer-software-inter-site">
    <title>Inter Site Image Transfer</title>
    <para>The image list transfer software is based upon X509 signed image lists containing 
      sha512 hashes.</para>
    <section id="imagetransfer-software-imagelist-creation">
      <title>Imagelist Creation</title>
      <para>This application creates manages and signs image lists.</para>
      <section id="imagetransfer-software-imagelist-creation-status">
        <title>Status</title>
        <para>This software is available at:</para>
        <code>https://github.com/hepix-virtualisation/hepixvmitrust</code>
        <para>The software is production grade, and has been used by
        many members of the &vwg; to generate signed image lists.</para>
        <section id="imagetransfer-software-imagelist-creation-status-features">
          <title>Features</title>
          <itemizedlist>
            <listitem>Command line application with library to support integration.</listitem>
            <listitem>Adds X509 Signature to lists of images.</listitem>
            <listitem>Ability to add and remove images to image list.</listitem>
            <listitem>Automatic setting of some meta data fields.</listitem>
            <listitem>Supports optional data fields.</listitem>
            <listitem>Import signed image lists for modification.</listitem>
            <listitem>Set all fields via enviroment variables.</listitem>
          </itemizedlist>
        </section>
        <xi:include href="imagetransfer-software-publisher.xml"/>
        <section id="imagetransfer-software-imagelist-creation-status-todo">
          <title>To Do (11-08-2011)</title>
          <itemizedlist>
            <listitem>Auto add CA and DN fields to image list.</listitem>
          </itemizedlist>
        </section>
      </section>
      <section id="imagetransfer-software-imagelist-creation-developer">
        <title>For developers - minimal.py</title>
        <para>This is an alternative implantation of an image list signer in python,
using the m2crypto wrapper for openssl as does the CLI.</para>
        <para>This version is very compact and simplistic.</para>
        <para>It is intended for products like repoman, VMIC and Petrags release
system, to see an example of signing thier own image lists, using
minimal code.</para>
        <para>The image list should be placed on a web server.</para>
      </section>
      <section id="imagetransfer-software-imagelist-creation-deployment">
        <title>Deployment of Image Lists</title>
        <para>The security of a signed message with an expiry date is fine to ensure
that a message is not faked. An old image can be presented to
subscribers blocking seeing the new image list. This is very unlikely
given HEP name server setups, but to have confidence this is not occurring
we need an authenticated connection with the web server and that means SSL.</para>
        <para>It is an image list producers decision if they provide http, or https
authenticated or even X509 authenticated access, Since this tool is based
on X509 trust I would suggest deploying on an X509 based web server and
not requiring client have an identify if possible, http(s) maybe enough
security for many this is a discussion point.</para>
        <para>the client of the signed message from a web server we should know that it has 
        connected to the correct web server. I am bias to adding restrictions such as only 
        supporting X509 https to some web servers. What do people think?</para>
      </section>
    </section>
    <section id="imagetransfer-software-imagelist-consumer">
      <title>Imagelist Consumption</title>
      <para>This application subscribes to image lists, downloads the latest and authenticates it.</para>
      <section id="imagetransfer-software-imagelist-consumer-status">
        <title>Status</title>
        <para>This software is available at:</para>
        <code>https://github.com/hepix-virtualisation/hepixvmilsubscriber</code>
        <para>The software is based upon a simple database that stores subscriptions to image lists,
          who can sign the image list, and which images belong to which subscriptions. It allows 
          images to selected for subscription.</para>
        <para>Subscribed images can be downloaded verified and cached. Cached images can be verified,
          and if invalid or expired they are moved to an expiry directory.</para>
        <para>This program will not provide an interface for admins to manage which images will be 
          approved by the site as this functionality is provided by the VMIC. This software is rather 
          a mechanism upon which tools such as the VMIC may select locally cached images for the 
          perposes of running on the local farm.</para>
        <section id="magetransfer-software-imagelist-consumer-status-features">
          <title>Features</title>
          <itemizedlist>
            <listitem>Add and delete multiple subscriptions to image lists.</listitem>
            <listitem>Update subscriptions checking authenticity of the message useng x509 based signatures.</listitem>
            <listitem>Automation as a cron script.</listitem>
            <listitem>Subscribe and unsubscribe to images from Imagelists.</listitem>
            <listitem>Download verify images into a local cache.</listitem>
            <listitem>Expire images to an archive when no longer endorsed or corrupt.</listitem>
          </itemizedlist>
        </section>

         <xi:include href="imagetransfer-software-subscriber.xml"/>

        <section id="imagetransfer-software-imagelist-consumer-status-todo">
          <title>To Do (16-05-2012)</title>
          <itemizedlist>
            <listitem>Only message authenticity is checked, does not yet check authenticity of transport.</listitem>
          </itemizedlist>
          <para>While it does check the authenticity of the message using X509, at the moment the 
            authenticity of the host is unchecked. For the programmability it would be far simpler to 
            use x509 certificates to check the host server. In terms of deployment it would be far 
            easier just to check any host key mechanism, as this is sufficient.</para>
        </section>
      </section>
    </section>
    <section id="imagetransfer-software-imagelist-deployment">
      <title>Image list tools deployment.</title>
      <para>The intra site tools are tested on every release for &rhel; 5 and 6 and are developed 
        on the &debian; platform. They are available as src and binary RPM packages in the following 
        repository sporting.</para>
      <itemizedlist>
        <listitem>http://grid.desy.de/vm/repo/yum/sl6/noarch/RPMS.stable/</listitem>
        <listitem>http://grid.desy.de/vm/repo/yum/sl5/noarch/RPMS.stable/</listitem>
      </itemizedlist>
      <para>Deployment instructions are provided in the README included in the source code and 
        the RPM.</para>
    </section>
  </section>
  <section id="imagetransfer-software-intra-site">
    <title>Intra Site Transfers.</title>
    <para>Tools for moving &vmi;'s around a site.</para>
    <section id="imagetransfer-software-VMIC">
      <title>VMIC</title>
      <para>This application manages which images can be deployed at a site.</para>
      <section id="imagetransfer-software-VMIC-status">
        <title>Status</title>
        <para>This software is available at:</para>
        <code>svn co svn+ssh://svn.cern.ch/reps/CloudServices/trunk/virtualization/</code>
        <para>This software has been deployed at CERN for some months and is currently used to manage 
        worker node deployment.</para>
        <section id="imagetransfer-software-VMIC-status-features">
          <title>Features</title>
          <itemizedlist>
            <listitem>Single web interface to manage image deployment as a site.</listitem>
            <listitem>Uses X509 signed image list to communicate with worker nodes.</listitem>
            <listitem>Allows multiple admins to manage site deployment.</listitem>
            <listitem>Provides the sites signed list of approved images to worker nodes.</listitem>
            <listitem>In production since October 2010 at CERN.</listitem>
          </itemizedlist>
          <note>Both the producer of an image and the site produce signed list of images, 
            these provide different functions, the image is signed by the producer to show 
            to the site the image came from the producer, while the site may sign a list 
            of images to allow them to be run at a site.</note>
        </section>
      </section>
    </section>
  </section>
</chapter>
